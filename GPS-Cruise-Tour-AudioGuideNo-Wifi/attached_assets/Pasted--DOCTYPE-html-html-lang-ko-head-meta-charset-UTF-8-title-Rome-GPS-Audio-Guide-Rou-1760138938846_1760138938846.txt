<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Rome GPS Audio Guide + Route</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100%; }
    body { margin: 0; font-family: 'Pretendard', sans-serif; }
    .info-box {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px 15px;
      border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000; font-size: 14px;
    }
    .route-btn {
      display: block; margin-top: 8px; padding: 6px 12px;
      border: none; background: #0078ff; color: white; border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-box">
    ğŸ“ <b>Rome GPS Audio Guide</b><br>
    ë°˜ê²½ 50m ì´ë‚´ ì ‘ê·¼ ì‹œ ìë™ ìŒì„± ê°€ì´ë“œ ì¬ìƒ<br>
    <button id="clearRoute" class="route-btn">ğŸ§­ ê¸¸ì°¾ê¸° ì´ˆê¸°í™”</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.13.0/dist/leaflet-geoman.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    // ===============================
    //  ëª…ì†Œ ë°ì´í„°
    // ===============================
    const pois = [
      { id: 'colosseum', name: 'ì½œë¡œì„¸ì›€', lat: 41.8902, lng: 12.4922, radius: 70,
        narration: 'ë¡œë§ˆì˜ ìƒì§•, ì½œë¡œì„¸ì›€ì…ë‹ˆë‹¤. ê²€íˆ¬ì‚¬ë“¤ì˜ ê²©íˆ¬ê°€ ì—´ë¦¬ë˜ ê³ ëŒ€ ì›í˜• ê²½ê¸°ì¥ì´ì£ .' },
      { id: 'roman_forum', name: 'ë¡œë§ˆ í¬ë£¸', lat: 41.8925, lng: 12.4853, radius: 60,
        narration: 'ë¡œë§ˆì˜ ì •ì¹˜ ì¤‘ì‹¬ì§€, í¬ë£¸ì…ë‹ˆë‹¤. ê³µí™”êµ­ ì‹œëŒ€ì˜ ì‹¬ì¥ë¶€ë¡œ, ì—­ì‚¬ì  ê±´ë¬¼ë“¤ì´ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.' },
      { id: 'trevi_fountain', name: 'íŠ¸ë ˆë¹„ ë¶„ìˆ˜', lat: 41.9009, lng: 12.4833, radius: 50,
        narration: 'íŠ¸ë ˆë¹„ ë¶„ìˆ˜ì…ë‹ˆë‹¤. ë™ì „ì„ ë˜ì§€ë©´ ë¡œë§ˆë¡œ ë‹¤ì‹œ ëŒì•„ì˜¨ë‹¤ëŠ” ì „ì„¤ì´ ìˆìŠµë‹ˆë‹¤.' },
      { id: 'pantheon', name: 'íŒí…Œì˜¨', lat: 41.8986, lng: 12.4768, radius: 50,
        narration: 'íŒí…Œì˜¨ì€ ëª¨ë“  ì‹ ë“¤ì—ê²Œ ë°”ì³ì§„ ì‹ ì „ìœ¼ë¡œ, ê³ ëŒ€ ê±´ì¶•ì˜ ê±¸ì‘ì…ë‹ˆë‹¤.' },
      { id: 'spanish_steps', name: 'ìŠ¤í˜ì¸ ê´‘ì¥', lat: 41.9059, lng: 12.4823, radius: 50,
        narration: 'ìŠ¤í˜ì¸ ê´‘ì¥ì€ ì˜í™” "ë¡œë§ˆì˜ íœ´ì¼" ì´¬ì˜ì§€ë¡œ ìœ ëª…í•©ë‹ˆë‹¤.' }
    ];

    // ===============================
    //  ì§€ë„ (OpenStreetMap + Leaflet)
    // ===============================
    const map = L.map('map').setView([41.8902, 12.4922], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ëª…ì†Œ ë§ˆì»¤ ì¶”ê°€
    pois.forEach(p => {
      const marker = L.marker([p.lat, p.lng]).addTo(map);
      marker.bindPopup(`<b>${p.name}</b><br><button onclick="setRoute(${p.lat},${p.lng})">ì´ê³³ìœ¼ë¡œ ê¸¸ì°¾ê¸°</button>`);
    });

    // ===============================
    //  ì˜¤ë””ì˜¤ ê°€ì´ë“œ (Web Speech API)
    // ===============================
    const spoken = new Set();
    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ko-KR';
      msg.rate = 1.0;
      window.speechSynthesis.speak(msg);
    }

    // ===============================
    //  ê±°ë¦¬ ê³„ì‚° (Haversine)
    // ===============================
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = v => v * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ===============================
    //  GPS ì¶”ì 
    // ===============================
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        pois.forEach(p => {
          const dist = getDistance(latitude, longitude, p.lat, p.lng);
          if (dist < p.radius && !spoken.has(p.id)) {
            spoken.add(p.id);
            speak(p.narration);
          }
        });
      }, err => console.error(err), { enableHighAccuracy: true });
    }

    // ===============================
    //  ê¸¸ì°¾ê¸° ê¸°ëŠ¥ (ë¬´ë£Œ API)
    // ===============================
    let routeControl = null;
    function setRoute(destLat, destLng) {
      if (routeControl) map.removeControl(routeControl);
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(map.getCenter().lat, map.getCenter().lng),
          L.latLng(destLat, destLng)
        ],
        router: L.Routing.openrouteservice('5b3ce3597851110001cf62483f9e12cf7b6f4f9eaeef70f0d9e18f17'),
        show: false,
        addWaypoints: false
      }).addTo(map);
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById("clearRoute").onclick = () => {
      if (routeControl) map.removeControl(routeControl);
      routeControl = null;
    };
  </script>
</body>
</html>